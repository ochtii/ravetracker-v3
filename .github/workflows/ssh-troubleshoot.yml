name: SSH Connection Troubleshooting

on:
  workflow_dispatch:

jobs:
  check-configuration:
    runs-on: ubuntu-latest
    
    steps:
    - name: Check GitHub Secrets
      run: |
        echo "🔍 Checking GitHub Secrets Configuration"
        echo "========================================"
        
        # Use length check instead of direct comparison
        if [ ${#GITHUB_HOST} -eq 0 ]; then
          echo "❌ HOST secret is missing"
        else
          echo "✅ HOST secret is configured"
        fi
        
        if [ ${#GITHUB_USERNAME} -eq 0 ]; then
          echo "❌ USERNAME secret is missing"
        else
          echo "✅ USERNAME secret is configured"
        fi
        
        if [ ${#GITHUB_SSH_KEY} -eq 0 ]; then
          echo "❌ SSH_KEY secret is missing"
        else
          echo "✅ SSH_KEY secret is configured"
        fi
        
        echo ""
        echo "📋 To configure secrets:"
        echo "Go to: https://github.com/ochtii/ravetracker-v3/settings/secrets/actions"
      env:
        GITHUB_HOST: ${{ secrets.HOST }}
        GITHUB_USERNAME: ${{ secrets.USERNAME }}
        GITHUB_SSH_KEY: ${{ secrets.SSH_KEY }}

  test-connection:
    needs: check-configuration
    runs-on: ubuntu-latest
    
    steps:
    - name: Test SSH Connection
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        port: ${{ secrets.PORT || '22' }}
        timeout: 30s
        command_timeout: 15s
        debug: true
        script: |
          echo "🎉 SSH Connection Successful!"
          echo "================================"
          echo "🏠 Server: $(hostname)"
          echo "👤 User: $(whoami)"
          echo "📍 Directory: $(pwd)"
          echo "🕒 Time: $(date)"
          
          # Check RaveTracker directory
          if [ ! -d "/var/www/ravetracker-v3" ]; then
            echo "📁 Creating /var/www/ravetracker-v3..."
            sudo mkdir -p /var/www/ravetracker-v3
            sudo chown $USER:$USER /var/www/ravetracker-v3
            echo "✅ Directory created"
          else
            echo "✅ /var/www/ravetracker-v3 exists"
            ls -la /var/www/ravetracker-v3/
          fi

  deploy-temp-build:
    needs: test-connection
    runs-on: ubuntu-latest
    
    steps:
    - name: Deploy RaveTracker temp_build
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        port: ${{ secrets.PORT || '22' }}
        timeout: 120s
        command_timeout: 60s
        debug: true
        script: |
          echo "🚀 Starting RaveTracker v3.0 temp_build deployment"
          echo "=================================================="
          
          cd /var/www/ravetracker-v3
          
          if [ ! -d "temp_build" ]; then
            echo "🔧 Cloning repository..."
            git clone https://github.com/ochtii/ravetracker-v3.git temp_build
          else
            echo "🔄 Updating repository..."
            cd temp_build
            git fetch origin main
            git reset --hard origin/main
            git clean -fd
            cd ..
          fi
          
          # Copy auto-update script if available
          if [ -f "temp_build/auto-update-temp-build.sh" ]; then
            cp temp_build/auto-update-temp-build.sh ./
            chmod +x auto-update-temp-build.sh
            echo "📋 Auto-update script installed"
          fi
          
          echo "✅ Deployment completed successfully!"
          echo "📊 Status:"
          echo "  - Repository: ochtii/ravetracker-v3"
          echo "  - Directory: /var/www/ravetracker-v3/temp_build"
          echo "  - Timestamp: $(date)"
