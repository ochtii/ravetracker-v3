name: SSH Connection Debug

on:
  workflow_dispatch:
    inputs:
      debug_level:
        description: 'Debug level (basic/full)'
        required: false
        default: 'basic'
        type: choice
        options:
        - basic
        - full

jobs:
  debug-ssh:
    runs-on: ubuntu-latest
    
    steps:
    - name: Basic SSH Connection Test
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        port: ${{ secrets.PORT || 22 }}
        timeout: 30s
        command_timeout: 15s
        debug: true
        script: |
          echo "🔗 SSH Connection successful!"
          echo "📍 Current directory: $(pwd)"
          echo "👤 Current user: $(whoami)"
          echo "🕒 Server time: $(date)"
          echo "💾 Available disk space:"
          df -h
          echo "🔍 Network interfaces:"
          ip addr show | grep -E "(inet|eth|ens)"
          
    - name: Full Diagnostic (if requested)
      if: github.event.inputs.debug_level == 'full'
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        port: ${{ secrets.PORT || 22 }}
        timeout: 60s
        command_timeout: 30s
        debug: true
        script: |
          echo "🔍 Full System Diagnostic"
          echo "========================"
          
          echo "📊 System Information:"
          uname -a
          cat /etc/os-release
          
          echo "🔧 SSH Configuration:"
          sudo ss -tlnp | grep :22
          
          echo "🌐 Network Connectivity:"
          ping -c 3 8.8.8.8 || echo "External connectivity issues"
          
          echo "🔐 SSH Authentication Methods:"
          grep -E "(PasswordAuthentication|PubkeyAuthentication)" /etc/ssh/sshd_config
          
          echo "📁 Project Directory Status:"
          ls -la /var/www/ravetracker-v3/
          
          echo "🔄 Git Status:"
          cd /var/www/ravetracker-v3/temp_build 2>/dev/null && git status || echo "temp_build not initialized"
