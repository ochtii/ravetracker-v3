name: Update temp_build

on:
  push:
    branches: [ main ]
    paths:
      - 'deploy/**'
      - 'ecosystem.config.**'
      - 'package.json'
      - 'svelte.config.js'
  workflow_dispatch:  # Manual trigger

jobs:
  update-temp-build:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸŸ¢ Setup Node.js (if needed)
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
        
      - name: ğŸ”„ Update temp_build on server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: "22"
          timeout: 60s
          command_timeout: 300s
          script: |
            echo "ğŸ”„ Auto-updating temp_build from GitHub Actions..."
            cd /var/www/ravetracker-v3
            
            # Run auto-update script
            if [ -f "auto-update-temp-build.sh" ]; then
              chmod +x auto-update-temp-build.sh
              ./auto-update-temp-build.sh
              echo "âœ… temp_build updated via GitHub Actions"
            else
              echo "âš ï¸ auto-update-temp-build.sh not found"
              echo "ğŸ“ Manual temp_build update..."
              
              if [ -d "temp_build" ]; then
                cd temp_build
                git fetch origin main
                git reset --hard origin/main
                git clean -fd
                echo "âœ… temp_build manually updated"
                
                # Copy scripts
                cd ..
                cp temp_build/deploy/*.sh ./
                chmod +x *.sh
                echo "ğŸ“‹ Scripts updated"
              else
                echo "âŒ temp_build directory not found"
              fi
            fi
            
      - name: ğŸ“¢ Notify update status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… temp_build update successful!"
          else
            echo "âŒ temp_build update failed!"
          fi
